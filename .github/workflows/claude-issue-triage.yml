name: Issue Triage

on:
  issues:
    types: [opened]

jobs:
  gatekeeper:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    outputs:
      trust_level: ${{ steps.check_reputation.outputs.level }}
    steps:
      - name: Check Reputation and Cooldown
        id: check_reputation
        uses: actions/github-script@v7
        with:
          script: |
            const authorAssociation = context.payload.issue.author_association;
            const user = context.payload.issue.user.login;
            const issueNumber = context.payload.issue.number;
            
            console.log(`Analyzing User: ${user} | Association: ${authorAssociation}`);

            // 1. Determine Trust Level
            let trustLevel = "untrusted";
            const trustedRoles = ["OWNER", "MEMBER", "COLLABORATOR", "CONTRIBUTOR"];
            
            if (trustedRoles.includes(authorAssociation)) {
              trustLevel = "trusted";
              console.log("âœ… User is TRUSTED (Repo Member/Contributor)");
            } else {
              console.log("âš ï¸ User is UNTRUSTED (New to repo)");
            }
            
            core.setOutput("level", trustLevel);

            // 2. Cooldown Enforcer (Only for Untrusted)
            if (trustLevel === "untrusted") {
              const COOLDOWN_MINUTES = 20;
              const timeLimit = new Date(Date.now() - COOLDOWN_MINUTES * 60 * 1000).toISOString();
              
              const query = `
                query($user: String!, $owner: String!, $repo: String!) {
                  search(query: "author:${user} repo:${owner}/${repo} type:issue created:>${timeLimit}", type: ISSUE, first: 10) {
                    issueCount
                  }
                }
              `;
              
              const variables = {
                user: user,
                owner: context.repo.owner,
                repo: context.repo.repo
              };
              
              const result = await github.graphql(query, variables);
              const count = result.search.issueCount;
              
              console.log(`Recent issues by ${user} in last ${COOLDOWN_MINUTES}m: ${count}`);

              if (count > 1) { // 1 is the current issue, so >1 means they created another one recently
                console.log("ðŸ›‘ COOLDOWN TRIGGERED");
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: "ðŸ›‘ **Speed Limit Reached**\n\nTo ensure quality and prevent spam, we limit first-time contributors to 1 issue every 20 minutes.\n\nThis issue will be automatically closed. Please wait before posting again."
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: "closed",
                  labels: ["spam", "invalid"]
                });
                
                core.setFailed("User hit rate limit. Workflow stopped.");
              }
            }

  triage:
    needs: gatekeeper
    runs-on: ubuntu-latest
    if: success() # Only run if Gatekeeper didn't fail
    timeout-minutes: 5 # Fast timeout to save money
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Triage and check for duplicates
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_non_write_users: "*"
          prompt: |
            Analyze and triage Issue #${{ github.event.issue.number }} in repository ${{ github.repository }}.

            ## User Context
            - **Trust Level**: ${{ needs.gatekeeper.outputs.trust_level }}
            - **Author**: ${{ github.event.issue.user.login }}

            ## Instructions
            You are the "Hive Triage Bot". Your behavior changes based on trust level.

            ### MODE A: TRUSTED USER
            (Use this if Trust Level is "trusted")
            - **Tone**: Helpful assistant.
            - **Action**: Categorize labels (bug, enhancement). Check duplicates lightly.
            - **Strictness**: Low. Assume good intent.

            ### MODE B: UNTRUSTED USER (Strict Gatekeeper)
            (Use this if Trust Level is "untrusted")
            - **Tone**: Strict quality control.
            - **Action**: REJECT immediately if the issue is low quality.
            
            **IMMEDIATE REJECTION CRITERIA (for Untrusted only):**
            1. **Vague**: Title < 3 words ("Help me", "Not working") or Description < 20 words.
            2. **Template Spam**: Keeps "Insert description here" text.
            3. **Hallucination**: Claims features that clearly don't exist in `core/` or `tools/`.
            4. **Low Effort**: No logs, no reproduction steps, no specific error message.

            **Rejection Steps:**
            1. Label as `invalid`.
            2. Comment: "Issue closed: Low Quality. Please provide logs, reproduction steps, and specific details. See `DEVELOPER.md`."
            3. Close the issue.
            4. STOP.

            ### General Tasks (If passed Gatekeeper):
            1. **Get Details**: Use `mcp__github__get_issue`.
            2. **Search Duplicates**: Use `mcp__github__search_issues`. If duplicate found, comment and link it.
            3. **Labeling**: Apply `bug`, `enhancement`, `question`, `documentation`.
            4. **First Issues**: If (and ONLY if) it is a strictly defined, small "good first issue", add that label.

            ## Tools Available:
            - mcp__github__get_issue
            - mcp__github__search_issues
            - mcp__github__list_issues
            - mcp__github__add_issue_comment
            - mcp__github__update_issue
            - mcp__github__get_issue_comments

            Execute swiftly.
            
          claude_args: |
            --model claude-haiku-4-5-20251001
            --allowedTools "mcp__github__get_issue,mcp__github__search_issues,mcp__github__list_issues,mcp__github__add_issue_comment,mcp__github__update_issue,mcp__github__get_issue_comments"
